import mongoose, { Document, ObjectId, Schema } from "mongoose";
import { Card, isCard, saveCard } from "../models/Card";
import { saveCardCollection } from "../models/CardCollection";
import { saveNonValidCard } from "../models/NoScryfallListing";

import { Types } from "mongoose"

//import 'dotenv/config'
//mongoose.connect(process.env.MONGO_URI as string);   

 export const saveCardsToDB = async (cards: unknown[], name: string) => {
     //set to any because setting to ObjectId[] doesnt work;
    let cardArr: any[] = [];
    if(!cards) {
        await saveNonValidCard(name);
        return;
    }
    else {
        for(const card of cards) {
            if(isCard(card)) {
                await saveCard(card.name, card.set, card);
                let foundCard = await Card.findOne({ name: card.name, set: card.set}).exec();
                if(foundCard) {
                    cardArr = [...cardArr,  foundCard?._id] ;
                }
            }
        };
    }
    if(isCard(cards[0]) && cardArr.length !== 0) {
        await saveCardCollection(cards[0].name, cardArr);
    }    
}
//const fakeCard = [{"object":"card","id":"bf76c6a4-d6e8-4d50-b65f-020252f7b659","oracle_id":"8a52f3c0-2552-4425-b2e3-5496eb2232a7","multiverse_ids":[],"name":"Mystic Remora","lang":"en","released_at":"2022-06-13","uri":"https://api.scryfall.com/cards/bf76c6a4-d6e8-4d50-b65f-020252f7b659","scryfall_uri":"https://scryfall.com/card/sld/406/mystic-remora?utm_source=api","layout":"normal","highres_image":true,"image_status":"highres_scan","image_uris":{"small":"https://c1.scryfall.com/file/scryfall-cards/small/front/b/f/bf76c6a4-d6e8-4d50-b65f-020252f7b659.jpg?1655156499","normal":"https://c1.scryfall.com/file/scryfall-cards/normal/front/b/f/bf76c6a4-d6e8-4d50-b65f-020252f7b659.jpg?1655156499","large":"https://c1.scryfall.com/file/scryfall-cards/large/front/b/f/bf76c6a4-d6e8-4d50-b65f-020252f7b659.jpg?1655156499","png":"https://c1.scryfall.com/file/scryfall-cards/png/front/b/f/bf76c6a4-d6e8-4d50-b65f-020252f7b659.png?1655156499","art_crop":"https://c1.scryfall.com/file/scryfall-cards/art_crop/front/b/f/bf76c6a4-d6e8-4d50-b65f-020252f7b659.jpg?1655156499","border_crop":"https://c1.scryfall.com/file/scryfall-cards/border_crop/front/b/f/bf76c6a4-d6e8-4d50-b65f-020252f7b659.jpg?1655156499"},"mana_cost":"{U}","cmc":1.0,"type_line":"Enchantment","oracle_text":"Cumulative upkeep {1} (At the beginning of your upkeep, put an age counter on this permanent, then sacrifice it unless you pay its upkeep cost for each age counter on it.)\nWhenever an opponent casts a noncreature spell, you may draw a card unless that player pays {4}.","colors":["U"],"color_identity":["U"],"keywords":["Cumulative upkeep"],"legalities":{"standard":"not_legal","future":"not_legal","historic":"not_legal","gladiator":"not_legal","pioneer":"not_legal","explorer":"not_legal","modern":"not_legal","legacy":"legal","pauper":"legal","vintage":"legal","penny":"not_legal","commander":"legal","brawl":"not_legal","historicbrawl":"not_legal","alchemy":"not_legal","paupercommander":"banned","duel":"legal","oldschool":"not_legal","premodern":"legal"},"games":[],"reserved":false,"foil":true,"nonfoil":true,"finishes":["nonfoil","foil"],"oversized":false,"promo":false,"reprint":false,"variation":false,"set_id":"4d92a8a7-ccb0-437d-abdc-9d70fc5ed672","set":"sld","set_name":"Secret Lair Drop","set_type":"box","set_uri":"https://api.scryfall.com/sets/4d92a8a7-ccb0-437d-abdc-9d70fc5ed672","set_search_uri":"https://api.scryfall.com/cards/search?order=set\u0026q=e%3Asld\u0026unique=prints","scryfall_set_uri":"https://scryfall.com/sets/sld?utm_source=api","rulings_uri":"https://api.scryfall.com/cards/bf76c6a4-d6e8-4d50-b65f-020252f7b659/rulings","prints_search_uri":"https://api.scryfall.com/cards/search?order=released\u0026q=oracleid%3A8a52f3c0-2552-4425-b2e3-5496eb2232a7\u0026unique=prints","collector_number":"406","digital":false,"rarity":"rare","flavor_text":"The bond between spellcaster and familiar allows the mage to detect even the smallest of magical ripplesâ€”and use them to their advantage.","card_back_id":"0aeebaf5-8c7d-4636-9e82-8c27447861f7","artist":"Kelogsloops","artist_ids":["10ab6961-89a9-44bf-bf5a-ff2548403a83"],"border_color":"borderless","frame":"2015","security_stamp":"oval","full_art":false,"textless":false,"booster":false,"story_spotlight":false,"promo_types":["boosterfun"],"edhrec_rank":84,"prices":{"usd":null,"usd_foil":null,"usd_etched":null,"eur":null,"eur_foil":null,"tix":null},"related_uris":{"tcgplayer_infinite_articles":"https://infinite.tcgplayer.com/search?contentMode=article\u0026game=magic\u0026partner=scryfall\u0026q=Mystic+Remora\u0026utm_campaign=affiliate\u0026utm_medium=api\u0026utm_source=scryfall","tcgplayer_infinite_decks":"https://infinite.tcgplayer.com/search?contentMode=deck\u0026game=magic\u0026partner=scryfall\u0026q=Mystic+Remora\u0026utm_campaign=affiliate\u0026utm_medium=api\u0026utm_source=scryfall","edhrec":"https://edhrec.com/route/?cc=Mystic+Remora"},"purchase_uris":{"tcgplayer":"https://www.tcgplayer.com/search/magic/product?productLineName=magic\u0026q=Mystic+Remora\u0026utm_campaign=affiliate\u0026utm_medium=api\u0026utm_source=scryfall\u0026view=grid","cardmarket":"https://www.cardmarket.com/en/Magic/Products/Search?referrer=scryfall\u0026searchString=Mystic+Remora\u0026utm_campaign=card_prices\u0026utm_medium=text\u0026utm_source=scryfall","cardhoarder":"https://www.cardhoarder.com/cards?affiliate_id=scryfall\u0026data%5Bsearch%5D=Mystic+Remora\u0026ref=card-profile\u0026utm_campaign=affiliate\u0026utm_medium=card\u0026utm_source=scryfall"}},{"object":"card","id":"13a08c07-e8b8-43bf-99e6-d268c79a62bf","oracle_id":"8a52f3c0-2552-4425-b2e3-5496eb2232a7","multiverse_ids":[159831],"mtgo_id":28055,"mtgo_foil_id":28056,"name":"Mystic Remora","lang":"en","released_at":"2007-09-10","uri":"https://api.scryfall.com/cards/13a08c07-e8b8-43bf-99e6-d268c79a62bf","scryfall_uri":"https://scryfall.com/card/me1/42/mystic-remora?utm_source=api","layout":"normal","highres_image":true,"image_status":"highres_scan","image_uris":{"small":"https://c1.scryfall.com/file/scryfall-cards/small/front/1/3/13a08c07-e8b8-43bf-99e6-d268c79a62bf.jpg?1559592432","normal":"https://c1.scryfall.com/file/scryfall-cards/normal/front/1/3/13a08c07-e8b8-43bf-99e6-d268c79a62bf.jpg?1559592432","large":"https://c1.scryfall.com/file/scryfall-cards/large/front/1/3/13a08c07-e8b8-43bf-99e6-d268c79a62bf.jpg?1559592432","png":"https://c1.scryfall.com/file/scryfall-cards/png/front/1/3/13a08c07-e8b8-43bf-99e6-d268c79a62bf.png?1559592432","art_crop":"https://c1.scryfall.com/file/scryfall-cards/art_crop/front/1/3/13a08c07-e8b8-43bf-99e6-d268c79a62bf.jpg?1559592432","border_crop":"https://c1.scryfall.com/file/scryfall-cards/border_crop/front/1/3/13a08c07-e8b8-43bf-99e6-d268c79a62bf.jpg?1559592432"},"mana_cost":"{U}","cmc":1.0,"type_line":"Enchantment","oracle_text":"Cumulative upkeep {1} (At the beginning of your upkeep, put an age counter on this permanent, then sacrifice it unless you pay its upkeep cost for each age counter on it.)\nWhenever an opponent casts a noncreature spell, you may draw a card unless that player pays {4}.","colors":["U"],"color_identity":["U"],"keywords":["Cumulative upkeep"],"legalities":{"standard":"not_legal","future":"not_legal","historic":"not_legal","gladiator":"not_legal","pioneer":"not_legal","explorer":"not_legal","modern":"not_legal","legacy":"legal","pauper":"legal","vintage":"legal","penny":"not_legal","commander":"legal","brawl":"not_legal","historicbrawl":"not_legal","alchemy":"not_legal","paupercommander":"banned","duel":"legal","oldschool":"not_legal","premodern":"legal"},"games":["mtgo"],"reserved":false,"foil":true,"nonfoil":true,"finishes":["nonfoil","foil"],"oversized":false,"promo":false,"reprint":true,"variation":false,"set_id":"407d388d-1abf-4c1d-b0c6-f56280898a1a","set":"me1","set_name":"Masters Edition","set_type":"masters","set_uri":"https://api.scryfall.com/sets/407d388d-1abf-4c1d-b0c6-f56280898a1a","set_search_uri":"https://api.scryfall.com/cards/search?order=set\u0026q=e%3Ame1\u0026unique=prints","scryfall_set_uri":"https://scryfall.com/sets/me1?utm_source=api","rulings_uri":"https://api.scryfall.com/cards/13a08c07-e8b8-43bf-99e6-d268c79a62bf/rulings","prints_search_uri":"https://api.scryfall.com/cards/search?order=released\u0026q=oracleid%3A8a52f3c0-2552-4425-b2e3-5496eb2232a7\u0026unique=prints","collector_number":"42","digital":true,"rarity":"uncommon","card_back_id":"0aeebaf5-8c7d-4636-9e82-8c27447861f7","artist":"Ken Meyer, Jr.","artist_ids":["466f5d1e-384e-47d9-8d2c-c6ae33ffa687"],"illustration_id":"ef16e23d-0b8d-4532-9d19-ffcb5025d264","border_color":"black","frame":"1997","full_art":false,"textless":false,"booster":true,"story_spotlight":false,"edhrec_rank":84,"prices":{"usd":null,"usd_foil":null,"usd_etched":null,"eur":null,"eur_foil":null,"tix":"9.94"},"related_uris":{"gatherer":"https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=159831","tcgplayer_infinite_articles":"https://infinite.tcgplayer.com/search?contentMode=article\u0026game=magic\u0026partner=scryfall\u0026q=Mystic+Remora\u0026utm_campaign=affiliate\u0026utm_medium=api\u0026utm_source=scryfall","tcgplayer_infinite_decks":"https://infinite.tcgplayer.com/search?contentMode=deck\u0026game=magic\u0026partner=scryfall\u0026q=Mystic+Remora\u0026utm_campaign=affiliate\u0026utm_medium=api\u0026utm_source=scryfall","edhrec":"https://edhrec.com/route/?cc=Mystic+Remora"},"purchase_uris":{"tcgplayer":"https://www.tcgplayer.com/search/magic/product?productLineName=magic\u0026q=Mystic+Remora\u0026utm_campaign=affiliate\u0026utm_medium=api\u0026utm_source=scryfall\u0026view=grid","cardmarket":"https://www.cardmarket.com/en/Magic/Products/Search?referrer=scryfall\u0026searchString=Mystic+Remora\u0026utm_campaign=card_prices\u0026utm_medium=text\u0026utm_source=scryfall","cardhoarder":"https://www.cardhoarder.com/cards/28055?affiliate_id=scryfall\u0026ref=card-profile\u0026utm_campaign=affiliate\u0026utm_medium=card\u0026utm_source=scryfall"}},{"object":"card","id":"58e93dff-b774-4765-b7bd-d3957e42ff4a","oracle_id":"8a52f3c0-2552-4425-b2e3-5496eb2232a7","multiverse_ids":[2523],"tcgplayer_id":4815,"cardmarket_id":6299,"name":"Mystic Remora","lang":"en","released_at":"1995-06-03","uri":"https://api.scryfall.com/cards/58e93dff-b774-4765-b7bd-d3957e42ff4a","scryfall_uri":"https://scryfall.com/card/ice/87/mystic-remora?utm_source=api","layout":"normal","highres_image":true,"image_status":"highres_scan","image_uris":{"small":"https://c1.scryfall.com/file/scryfall-cards/small/front/5/8/58e93dff-b774-4765-b7bd-d3957e42ff4a.jpg?1562911406","normal":"https://c1.scryfall.com/file/scryfall-cards/normal/front/5/8/58e93dff-b774-4765-b7bd-d3957e42ff4a.jpg?1562911406","large":"https://c1.scryfall.com/file/scryfall-cards/large/front/5/8/58e93dff-b774-4765-b7bd-d3957e42ff4a.jpg?1562911406","png":"https://c1.scryfall.com/file/scryfall-cards/png/front/5/8/58e93dff-b774-4765-b7bd-d3957e42ff4a.png?1562911406","art_crop":"https://c1.scryfall.com/file/scryfall-cards/art_crop/front/5/8/58e93dff-b774-4765-b7bd-d3957e42ff4a.jpg?1562911406","border_crop":"https://c1.scryfall.com/file/scryfall-cards/border_crop/front/5/8/58e93dff-b774-4765-b7bd-d3957e42ff4a.jpg?1562911406"},"mana_cost":"{U}","cmc":1.0,"type_line":"Enchantment","oracle_text":"Cumulative upkeep {1} (At the beginning of your upkeep, put an age counter on this permanent, then sacrifice it unless you pay its upkeep cost for each age counter on it.)\nWhenever an opponent casts a noncreature spell, you may draw a card unless that player pays {4}.","colors":["U"],"color_identity":["U"],"keywords":["Cumulative upkeep"],"legalities":{"standard":"not_legal","future":"not_legal","historic":"not_legal","gladiator":"not_legal","pioneer":"not_legal","explorer":"not_legal","modern":"not_legal","legacy":"legal","pauper":"legal","vintage":"legal","penny":"not_legal","commander":"legal","brawl":"not_legal","historicbrawl":"not_legal","alchemy":"not_legal","paupercommander":"banned","duel":"legal","oldschool":"not_legal","premodern":"legal"},"games":["paper"],"reserved":false,"foil":false,"nonfoil":true,"finishes":["nonfoil"],"oversized":false,"promo":false,"reprint":false,"variation":false,"set_id":"b0e08eea-5c01-4406-a6e2-dcd09c5e5b67","set":"ice","set_name":"Ice Age","set_type":"expansion","set_uri":"https://api.scryfall.com/sets/b0e08eea-5c01-4406-a6e2-dcd09c5e5b67","set_search_uri":"https://api.scryfall.com/cards/search?order=set\u0026q=e%3Aice\u0026unique=prints","scryfall_set_uri":"https://scryfall.com/sets/ice?utm_source=api","rulings_uri":"https://api.scryfall.com/cards/58e93dff-b774-4765-b7bd-d3957e42ff4a/rulings","prints_search_uri":"https://api.scryfall.com/cards/search?order=released\u0026q=oracleid%3A8a52f3c0-2552-4425-b2e3-5496eb2232a7\u0026unique=prints","collector_number":"87","digital":false,"rarity":"common","card_back_id":"0aeebaf5-8c7d-4636-9e82-8c27447861f7","artist":"Ken Meyer, Jr.","artist_ids":["466f5d1e-384e-47d9-8d2c-c6ae33ffa687"],"illustration_id":"ef16e23d-0b8d-4532-9d19-ffcb5025d264","border_color":"black","frame":"1993","full_art":false,"textless":false,"booster":true,"story_spotlight":false,"edhrec_rank":84,"prices":{"usd":"9.29","usd_foil":null,"usd_etched":null,"eur":"9.12","eur_foil":null,"tix":null},"related_uris":{"gatherer":"https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=2523","tcgplayer_infinite_articles":"https://infinite.tcgplayer.com/search?contentMode=article\u0026game=magic\u0026partner=scryfall\u0026q=Mystic+Remora\u0026utm_campaign=affiliate\u0026utm_medium=api\u0026utm_source=scryfall","tcgplayer_infinite_decks":"https://infinite.tcgplayer.com/search?contentMode=deck\u0026game=magic\u0026partner=scryfall\u0026q=Mystic+Remora\u0026utm_campaign=affiliate\u0026utm_medium=api\u0026utm_source=scryfall","edhrec":"https://edhrec.com/route/?cc=Mystic+Remora"},"purchase_uris":{"tcgplayer":"https://www.tcgplayer.com/product/4815?page=1\u0026utm_campaign=affiliate\u0026utm_medium=api\u0026utm_source=scryfall","cardmarket":"https://www.cardmarket.com/en/Magic/Products/Search?referrer=scryfall\u0026searchString=Mystic+Remora\u0026utm_campaign=card_prices\u0026utm_medium=text\u0026utm_source=scryfall","cardhoarder":"https://www.cardhoarder.com/cards?affiliate_id=scryfall\u0026data%5Bsearch%5D=Mystic+Remora\u0026ref=card-profile\u0026utm_campaign=affiliate\u0026utm_medium=card\u0026utm_source=scryfall"}}]
//saveCardsToDB(fakeCard, fakeCard[0].name)

/*
          const cardArr = []
        await saveCard(fakeCard.name, fakeCard.set, fakeCard);

        let card = await Card.findOne({ name: fakeCard.name }).exec();

        cardArr.push(card?._id as unknown as ObjectId);

        console.log(card)
        await saveCardCollection(fakeCard.name, cardArr);
*/

/*

        let card = await CardCollection.findOne({ name: fakeCard.name }).populate({path: 'sets', model: Card}).exec()
        if (isCard(card?.sets[0])) {
            console.log(card?.sets[0].details.name);
        } else {
            console.log('Not type card');
        }
*/